<!DOCTYPE html>
<html>
<head>
  <title>Product Sniper</title>

  <style>
    body {
      font-family: Arial;
      background: #020617;
      color: white;
      text-align: center;
      padding: 50px;
    }

    input {
      width: 400px;
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
    }

    button {
      padding: 12px 20px;
      background: #38bdf8;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-left: 10px;
    }

    #result-box {
      margin-top: 30px;
      padding: 25px;
      border-radius: 10px;
      background: #020617;
      border: 1px solid #334155;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

#result {
    margin-top: 20px;
    margin-bottom: 20px;
    font-size: 16px;
    color: #9ca3af;
}

/* Loading Spinner */

#loading {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-top: 15px;
  color: #ccc;
  font-size: 16px;
}

.hidden {
  display: none;
}

.spinner {
  width: 18px;
  height: 18px;
  border: 3px solid rgba(255,255,255,0.2);
  border-top: 3px solid #4fc3f7;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

#history-box {
  margin-top: 30px;
  padding: 20px;
  border: 1px solid #334155;
  border-radius: 10px;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
  background: #020617;
}

#history-box h3 {
  margin-bottom: 10px;
}

#history-list {
  list-style: none;
  padding: 0;
}

#history-list li {
  padding: 6px 0;
  border-bottom: 1px solid #1e293b;
  font-size: 14px;
}

  </style>
</head>

<body>

  <h1>ðŸš€ Product Sniper</h1>
  <p>Paste a product link and analyze it.</p>

  <input
    id="link"
    type="text"
    placeholder="Paste product link here"
  >

<button id="analyzeBtn" onclick="analyze()">Analyze</button>

<div id="loading" style="display:none;">
  <div class="spinner"></div>
  <span>Analyzing...</span>
</div>

<div id="result"></div>


  <div id="result-box">
    <div id="score"></div>
    <div id="verdict"></div>
    <div id="reason"></div>
  </div>

<div id="history-box">
  <h3>ðŸ“œ Recent Analyses</h3>
  <ul id="history-list"></ul>
</div>


<script>


  const btn = document.getElementById("analyzeBtn");
  btn.addEventListener("click", analyze);
});
document.addEventListener("DOMContentLoaded", () => {

renderHistory();
  console.log("Already running, blocked.");
});

function setLoading(isLoading) {

  const btn = document.getElementById("analyzeBtn");
  const loading = document.getElementById("loading");

  if (isLoading) {

    btn.disabled = true;
    btn.innerText = "Working...";
    loading.style.display = "flex";

  } else {

    btn.disabled = false;
    btn.innerText = "Analyze";
    loading.style.display = "none";

  }
}


async function analyze() {

  const input = document.getElementById("link");
  const result = document.getElementById("result");

  const link = input.value.trim();

  if (!link) {
    alert("Please paste a link first.");
    return;
  }

  setLoading(true);
  result.innerText = "";

try {

  const controller = new AbortController();

  const timeout = setTimeout(() => {
    controller.abort();
  }, 10000); // 10s timeout


  const res = await fetch(
    `/analyze?link=${encodeURIComponent(link)}`,
    {
      signal: controller.signal
    }
  );

  clearTimeout(timeout);


  if (!res.ok) {
    throw new Error("Server error");
  }

  const data = await res.json();

  console.log("SERVER:", data);

  showResult(data);

}

  } catch (err) {

    console.error(err);

if (err.name === "AbortError") {
  result.innerText = "âŒ Connection timeout. Check internet.";
} else {
  result.innerText = "âŒ Network / server error.";
}

  } finally {

    setLoading(false);

  }
}


function showResult(data) {

  if (!data || !data.analysis) {
    document.getElementById("result").innerText =
      "âŒ No analysis returned.";
    return;
  }

  let analysis = data.analysis;

  // Convert string â†’ object if needed
  if (typeof analysis === "string") {
    try {
      analysis = JSON.parse(analysis);
    } catch (e) {
      document.getElementById("result").innerText =
        "âŒ Analysis parse error.";
      return;
    }
  }

  // Safety check
  if (analysis.total === undefined ||
      analysis.verdict === undefined ||
      analysis.reason === undefined) {

    document.getElementById("result").innerText =
      "âŒ Invalid analysis format.";
    return;
  }

  const total = analysis.total;
  const verdict = analysis.verdict;
  const reason = analysis.reason;

  // Clear error message
  document.getElementById("result").innerText = "";

  document.getElementById("score").innerText =
    "Score: " + total + " / 10";

  const verdictBox =
    document.getElementById("verdict");

  verdictBox.innerText =
    "Verdict: " + verdict;

  if (verdict === "SCALE") {
    verdictBox.style.color = "lime";
  }
  else if (verdict === "TEST") {
    verdictBox.style.color = "orange";
  }
  else {
    verdictBox.style.color = "red";
  }

    "Reason: " + reason;
document.getElementById("reason").innerText =
    "Reason: " + reason;
saveToHistory(data.link, analysis);
}

function saveToHistory(link, analysis) {

  let history = JSON.parse(
    localStorage.getItem("history") || "[]"
  );

  history.unshift({
    link,
    score: analysis.total,
    verdict: analysis.verdict
  });

  history = history.slice(0, 10);

  localStorage.setItem("history", JSON.stringify(history));

  renderHistory();
}

function renderHistory() {

  const list = document.getElementById("history-list");

  const history = JSON.parse(
    localStorage.getItem("history") || "[]"
  );

  list.innerHTML = "";

  history.forEach(item => {

    const li = document.createElement("li");

    li.innerText =
      `${item.link} â€” ${item.verdict} (${item.score}/10)`;

    list.appendChild(li);

  });
}

</script>


</body>
</html>


